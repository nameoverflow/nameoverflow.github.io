<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>如何编译函数闭包 | nameoverflow</title>
  
  
  <!--link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github-gist.min.css"-->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github-gist.min.css">
  <link rel="stylesheet" href="/css/style.css"><!-- hexo-inject:begin --><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css'><!-- hexo-inject:end -->
</head>

<body>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="Shell">
    <aside class='SideBar'>
    <section class='avatar' style="background-image: url(/assets/header.png)">
        <div class='av-pic' style="background-image: url(/assets/tree_small.png)">
        </div>
    </section>
    <section class='menu'>
        <div>nameoverflow</div>
        
            <div>What the f__k?</div>
        
        <ul>
          
            <a href="/" class="Btn">
              <li>Home</li>
            </a>  
          
            <a href="/archives/" class="Btn">
              <li>Archive</li>
            </a>  
          
            <a href="/tags/" class="Btn">
              <li>Tags</li>
            </a>  
          
            <a href="/about/" class="Btn">
              <li>About</li>
            </a>  
          
        </ul>
    </section>
    <section class="media">
        
            
                <a href="https://github.com/nameoverflow">
                    <img src="/assets/github.svg" />
                </a>
            
        
            
                <a href="https://www.facebook.com/profile.php?id=100004252391322">
                    <img src="/assets/facebook.svg" />
                </a>
            
        
    </section>
</aside>

    <div class="container">
        <div data-pager-shell>
            <div>
  <article class='ContentView'>
    <header class='PageTitle'>
        <h1>如何编译函数闭包</h1>
    </header>

    <section>
      <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>// 知乎不仅不给我开专栏还说我这篇文章zz敏感，破网站吃枣药丸</p>
<blockquote>
<p> <strong>闭包</strong>（英语：Closure），又称<strong>词法闭包</strong>（Lexical Closure）或<strong>函数闭包</strong>（function closures），是引用了自由变量的函数。这个被引用的自由变量将和这个函数一同存在，即使已经离开了创造它的环境也不例外。所以，有另一种说法认为闭包是由函数和与其相关的引用环境组合而成的实体。闭包在运行时可以有多个实例，不同的引用环境和相同的函数组合可以产生不同的实例。</p>
</blockquote>
<p>想要实现一个同时支持词法作用域与 first-class function 的编程语言，一个重要的转换就是所谓的 lambda-lifting：把嵌套函数定义（包括匿名函数）转换为独立的全局函数定义；把自由变量的引用转换为参数传递。</p>
<a id="more"></a>
<h2 id="函数定义的转化"><a href="#函数定义的转化" class="headerlink" title="函数定义的转化"></a>函数定义的转化</h2><p>简便起见，这里定义一个简单的语言表示</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtable><mtr><mtd><mrow><mi>e</mi><mi>x</mi><mi>p</mi><mtext> </mtext><mo>:</mo><mo>:</mo><mo>=</mo><mtext> </mtext></mrow></mtd><mtd><mrow><mrow></mrow><mi>L</mi><mi>a</mi><mi>m</mi><mo>(</mo><mi>i</mi><mi>d</mi><mo separator="true">,</mo><mi>e</mi><mi>x</mi><mi>p</mi><mo>)</mo></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd><mtd><mrow><mrow></mrow><mi>A</mi><mi>p</mi><mi>p</mi><mo>(</mo><mi>e</mi><mi>x</mi><mi>p</mi><mo separator="true">,</mo><mi>e</mi><mi>x</mi><mi>p</mi><mo>)</mo></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd><mtd><mrow><mrow></mrow><mi>L</mi><mi>e</mi><mi>t</mi><mo>(</mo><mi>i</mi><mi>d</mi><mo separator="true">,</mo><mi>e</mi><mi>x</mi><mi>p</mi><mo separator="true">,</mo><mi>e</mi><mi>x</mi><mi>p</mi><mo>)</mo></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd><mtd><mrow><mrow></mrow><mi>V</mi><mi>a</mi><mi>r</mi><mo>(</mo><mi>i</mi><mi>d</mi><mo>)</mo></mrow></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">\begin{aligned}
exp\ ::=\ &amp;Lam(id,exp)\\\\
&amp;App(exp,exp)\\\\
&amp;Let(id,exp,exp)\\\\
&amp;Var(id)
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:4.45em;"></span><span class="strut bottom" style="height:8.4em;vertical-align:-3.95em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist"><span style="top:-3.6100000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit">e</span><span class="mord mathit">x</span><span class="mord mathit">p</span><span class="mord mspace"> </span><span class="mrel">:</span><span class="mrel">:</span><span class="mrel">=</span><span class="mord mspace"> </span></span></span><span style="top:-2.4100000000000006em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span style="top:-1.2100000000000006em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span style="top:-0.010000000000000397em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span style="top:1.1899999999999997em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span style="top:2.39em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span style="top:3.5900000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="col-align-l"><span class="vlist"><span style="top:-3.6100000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mord mathit">L</span><span class="mord mathit">a</span><span class="mord mathit">m</span><span class="mopen">(</span><span class="mord mathit">i</span><span class="mord mathit">d</span><span class="mpunct">,</span><span class="mord mathit">e</span><span class="mord mathit">x</span><span class="mord mathit">p</span><span class="mclose">)</span></span></span><span style="top:-1.2100000000000006em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mord mathit">A</span><span class="mord mathit">p</span><span class="mord mathit">p</span><span class="mopen">(</span><span class="mord mathit">e</span><span class="mord mathit">x</span><span class="mord mathit">p</span><span class="mpunct">,</span><span class="mord mathit">e</span><span class="mord mathit">x</span><span class="mord mathit">p</span><span class="mclose">)</span></span></span><span style="top:1.1899999999999997em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mord mathit">L</span><span class="mord mathit">e</span><span class="mord mathit">t</span><span class="mopen">(</span><span class="mord mathit">i</span><span class="mord mathit">d</span><span class="mpunct">,</span><span class="mord mathit">e</span><span class="mord mathit">x</span><span class="mord mathit">p</span><span class="mpunct">,</span><span class="mord mathit">e</span><span class="mord mathit">x</span><span class="mord mathit">p</span><span class="mclose">)</span></span></span><span style="top:3.5900000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mord mathit" style="margin-right:0.22222em;">V</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mord mathit">i</span><span class="mord mathit">d</span><span class="mclose">)</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></span></span>
<p>这个语言类似于 untyped lambda calculus，有 lambda、apply 语句，只是多了一个 let 语句用于绑定一个变量。一般语言中的一些表达式形式（如 binary operator）一般则可以看作是 apply 的特殊形式。</p>
<p>用 Rust 代码写出来大概是这样</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Exp</span></span> &#123;</div><div class="line">    <span class="comment">/// Lambda 抽象，参数名 -&gt; 函数体</span></div><div class="line">    Abs(Id, <span class="built_in">Box</span>&lt;Exp&gt;),</div><div class="line">    <span class="comment">/// Let 定义，let 变量名 = 变量值 in 表达式</span></div><div class="line">    Let(Id, <span class="built_in">Box</span>&lt;Exp&gt;, <span class="built_in">Box</span>&lt;Exp&gt;),</div><div class="line">    <span class="comment">/// 函数应用，变量名(参数)</span></div><div class="line">    App(<span class="built_in">Box</span>&lt;Exp&gt;, <span class="built_in">Box</span>&lt;Exp&gt;)，</div><div class="line">    Var(Id),</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们要做的事情是提取出一个匿名函数定义（lambda）中的自由变量，把匿名函数定义转换为全局函数定义，并将函数定义入口和自由变量列表打包成一个实体（即所谓闭包），替换原来的 lambda 节点。</p>
<p>这样，转换之后的 AST 中没有了 lambda 节点，取而代之的是类似 let 节点的闭包 closure 定义节点。</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtable><mtr><mtd><mrow><mi>t</mi><mi>e</mi><mi>r</mi><mi>m</mi><mtext> </mtext><mo>:</mo><mo>:</mo><mo>=</mo><mtext> </mtext></mrow></mtd><mtd><mrow><mrow></mrow><mi>C</mi><mi>l</mi><mi>s</mi><mo>(</mo><mi>i</mi><mi>d</mi><mo separator="true">,</mo><mi>c</mi><mi>l</mi><mi>s</mi><mo separator="true">,</mo><mi>t</mi><mi>e</mi><mi>r</mi><mi>m</mi><mo>)</mo></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd><mtd><mrow><mrow></mrow><mi>A</mi><mi>p</mi><mi>p</mi><mo>(</mo><mi>t</mi><mi>e</mi><mi>r</mi><mi>m</mi><mo separator="true">,</mo><mi>t</mi><mi>e</mi><mi>r</mi><mi>m</mi><mo>)</mo></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd><mtd><mrow><mrow></mrow><mi>L</mi><mi>e</mi><mi>t</mi><mo>(</mo><mi>i</mi><mi>d</mi><mo separator="true">,</mo><mi>t</mi><mi>e</mi><mi>r</mi><mi>m</mi><mo separator="true">,</mo><mi>t</mi><mi>e</mi><mi>r</mi><mi>m</mi><mo>)</mo></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd><mtd><mrow><mrow></mrow><mi>V</mi><mi>a</mi><mi>r</mi><mo>(</mo><mi>i</mi><mi>d</mi><mo>)</mo></mrow></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">\begin{aligned}
term\ ::= \ &amp;Cls(id,cls,term)\\\\
&amp;App(term,term)\\\\
&amp;Let(id,term,term)\\\\
&amp;Var(id)
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:4.45em;"></span><span class="strut bottom" style="height:8.4em;vertical-align:-3.95em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist"><span style="top:-3.6100000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit">t</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">m</span><span class="mord mspace"> </span><span class="mrel">:</span><span class="mrel">:</span><span class="mrel">=</span><span class="mord mspace"> </span></span></span><span style="top:-2.4100000000000006em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span style="top:-1.2100000000000006em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span style="top:-0.010000000000000397em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span style="top:1.1899999999999997em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span style="top:2.39em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span style="top:3.5900000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="col-align-l"><span class="vlist"><span style="top:-3.6100000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">s</span><span class="mopen">(</span><span class="mord mathit">i</span><span class="mord mathit">d</span><span class="mpunct">,</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">s</span><span class="mpunct">,</span><span class="mord mathit">t</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">m</span><span class="mclose">)</span></span></span><span style="top:-1.2100000000000006em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mord mathit">A</span><span class="mord mathit">p</span><span class="mord mathit">p</span><span class="mopen">(</span><span class="mord mathit">t</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">m</span><span class="mpunct">,</span><span class="mord mathit">t</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">m</span><span class="mclose">)</span></span></span><span style="top:1.1899999999999997em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mord mathit">L</span><span class="mord mathit">e</span><span class="mord mathit">t</span><span class="mopen">(</span><span class="mord mathit">i</span><span class="mord mathit">d</span><span class="mpunct">,</span><span class="mord mathit">t</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">m</span><span class="mpunct">,</span><span class="mord mathit">t</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">m</span><span class="mclose">)</span></span></span><span style="top:3.5900000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mord mathit" style="margin-right:0.22222em;">V</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mord mathit">i</span><span class="mord mathit">d</span><span class="mclose">)</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></span></span>
<figure class="highlight rust"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Term</span></span> &#123;</div><div class="line">    Cls(Id, <span class="built_in">Box</span>&lt;Cls&gt;, <span class="built_in">Box</span>&lt;Term&gt;),</div><div class="line">    App(<span class="built_in">Box</span>&lt;Term&gt;, <span class="built_in">Box</span>&lt;Term&gt;),</div><div class="line">    Let(Id, <span class="built_in">Box</span>&lt;Term&gt;, <span class="built_in">Box</span>&lt;Term&gt;),</div><div class="line">    Var(Id),</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>闭包实体 Cls 中需要保存全局函数定义的入口和当前环境中自由变量的列表。</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtable><mtr><mtd><mrow><mi>c</mi><mi>l</mi><mi>s</mi><mtext> </mtext><mo>:</mo><mo>:</mo><mo>=</mo><mtext> </mtext></mrow></mtd><mtd><mrow><mrow></mrow><mo>(</mo><mi>l</mi><mi>a</mi><mi>b</mi><mi>e</mi><mi>l</mi><mo separator="true">,</mo><mo>(</mo><mi>f</mi><msub><mi>v</mi><mn>1</mn></msub><mo separator="true">,</mo><mi>f</mi><msub><mi>v</mi><mn>2</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mi>f</mi><msub><mi>v</mi><mi>n</mi></msub><mo>)</mo><mo>)</mo></mrow></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">\begin{aligned}
cls\ ::=\ &amp;(label,(fv_1,fv_2,...,fv_n))
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8500000000000001em;"></span><span class="strut bottom" style="height:1.2000000000000002em;vertical-align:-0.35000000000000003em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist"><span style="top:-0.010000000000000009em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit">c</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">s</span><span class="mord mspace"> </span><span class="mrel">:</span><span class="mrel">:</span><span class="mrel">=</span><span class="mord mspace"> </span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="col-align-l"><span class="vlist"><span style="top:-0.010000000000000009em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">a</span><span class="mord mathit">b</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mpunct">,</span><span class="mord mathrm">.</span><span class="mord mathrm">.</span><span class="mord mathrm">.</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">n</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></span></span>
<figure class="highlight rust"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Cls</span></span> &#123;</div><div class="line">    label: Id,</div><div class="line">    fvs: <span class="built_in">Vec</span>&lt;Id&gt;,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于需要保持自由变量的信息，全局函数定义需要保存一个自由变量的列表。</p>
<p>这样我们有了全局函数定义的表示——入口 label，参数名，函数体，自由变量列表</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtable><mtr><mtd><mrow><mi>f</mi><mi>u</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>f</mi><mtext> </mtext><mo>:</mo><mo>:</mo><mo>=</mo><mtext> </mtext></mrow></mtd><mtd><mrow><mrow></mrow><mi>f</mi><mi>u</mi><mi>n</mi><mo>(</mo><mi>l</mi><mi>a</mi><mi>b</mi><mi>e</mi><mi>l</mi><mo separator="true">,</mo><mi>i</mi><mi>d</mi><mo separator="true">,</mo><mi>e</mi><mi>x</mi><mi>p</mi><mo separator="true">,</mo><mo>(</mo><mi>f</mi><msub><mi>v</mi><mn>1</mn></msub><mo separator="true">,</mo><mi>f</mi><msub><mi>v</mi><mn>2</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mi>f</mi><msub><mi>v</mi><mi>n</mi></msub><mo>)</mo><mo>)</mo></mrow></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">\begin{aligned}
fundef\ ::=\ &amp;fun(label,id,exp,(fv_1,fv_2,...,fv_n))
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8500000000000001em;"></span><span class="strut bottom" style="height:1.2000000000000002em;vertical-align:-0.35000000000000003em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist"><span style="top:-0.010000000000000009em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit">u</span><span class="mord mathit">n</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mspace"> </span><span class="mrel">:</span><span class="mrel">:</span><span class="mrel">=</span><span class="mord mspace"> </span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="col-align-l"><span class="vlist"><span style="top:-0.010000000000000009em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit">u</span><span class="mord mathit">n</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">a</span><span class="mord mathit">b</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mord mathit">i</span><span class="mord mathit">d</span><span class="mpunct">,</span><span class="mord mathit">e</span><span class="mord mathit">x</span><span class="mord mathit">p</span><span class="mpunct">,</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mpunct">,</span><span class="mord mathrm">.</span><span class="mord mathrm">.</span><span class="mord mathrm">.</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">n</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></span></span>
<figure class="highlight rust"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Fundef</span></span> &#123;</div><div class="line">    <span class="keyword">pub</span> label: Id,</div><div class="line">    <span class="keyword">pub</span> param: Id,</div><div class="line">    <span class="keyword">pub</span> body: Term,</div><div class="line">    <span class="keyword">pub</span> fvs: <span class="built_in">Vec</span>&lt;Id&gt;,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="自由变量的提取"><a href="#自由变量的提取" class="headerlink" title="自由变量的提取"></a>自由变量的提取</h2><p>自由变量的提取规则其实就是变量加入环境的逆过程。</p>
<ul>
<li>变量表达式（Var）的自由变量就是变量自己</li>
<li>函数应用（Apply）的自由变量是 callee 的自由变量和参数的自由变量取并集</li>
<li>Let 节点和 Cls 节点定义的变量，从其后继表达式的自由变量中剔除，然后与初始化值表达式的自由变量合并。</li>
</ul>
<p>即</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtable><mtr><mtd><mrow><mi>f</mi><mi>v</mi><mo>(</mo><mi>V</mi><mi>a</mi><mi>r</mi><mo>(</mo><mi>v</mi><mo>)</mo><mo>)</mo></mrow></mtd><mtd><mrow><mrow></mrow><mo>=</mo><mo>{</mo><mi>v</mi><mo>}</mo></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd></mtr><mtr><mtd><mrow><mi>f</mi><mi>v</mi><mo>(</mo><mi>A</mi><mi>p</mi><mi>p</mi><mo>(</mo><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>e</mi><mo separator="true">,</mo><mi>a</mi><mi>r</mi><mi>g</mi><mo>)</mo><mo>)</mo></mrow></mtd><mtd><mrow><mrow></mrow><mo>=</mo><mi>f</mi><mi>v</mi><mo>(</mo><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>e</mi><mo>)</mo><mtext> </mtext><mo>∪</mo><mtext> </mtext><mi>f</mi><mi>v</mi><mo>(</mo><mi>a</mi><mi>r</mi><mi>g</mi><mo>)</mo></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd></mtr><mtr><mtd><mrow><mi>f</mi><mi>v</mi><mo>(</mo><mi>L</mi><mi>e</mi><mi>t</mi><mo>(</mo><mi>v</mi><mo separator="true">,</mo><mi>v</mi><mi>a</mi><mi>l</mi><mo separator="true">,</mo><mi>e</mi><mi>x</mi><mi>p</mi><mo>)</mo><mo>)</mo></mrow></mtd><mtd><mrow><mrow></mrow><mo>=</mo><mi>f</mi><mi>v</mi><mo>(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mo>)</mo><mtext> </mtext><mo>∪</mo><mtext> </mtext><mi>f</mi><mi>v</mi><mo>(</mo><mi>e</mi><mi>x</mi><mi>p</mi><mo>)</mo><mtext> </mtext><mo>−</mo><mtext> </mtext><mo>{</mo><mi>v</mi><mo>}</mo></mrow></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">\begin{aligned}
fv(Var(v))&amp;=\{v\}\\\\
fv(App(callee,arg))&amp;=fv(callee) \ \cup \ fv(arg)\\\\
fv(Let(v,val,exp))&amp;=fv(val) \ \cup\ fv(exp)\ -\ \{v\}
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:3.25em;"></span><span class="strut bottom" style="height:6em;vertical-align:-2.7500000000000004em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist"><span style="top:-2.41em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.22222em;">V</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mclose">)</span></span></span><span style="top:-1.2100000000000002em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span style="top:-0.009999999999999953em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="mopen">(</span><span class="mord mathit">A</span><span class="mord mathit">p</span><span class="mord mathit">p</span><span class="mopen">(</span><span class="mord mathit">c</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">e</span><span class="mord mathit">e</span><span class="mpunct">,</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="mclose">)</span><span class="mclose">)</span></span></span><span style="top:1.1900000000000002em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span style="top:2.3900000000000006em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="mopen">(</span><span class="mord mathit">L</span><span class="mord mathit">e</span><span class="mord mathit">t</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mord mathit">e</span><span class="mord mathit">x</span><span class="mord mathit">p</span><span class="mclose">)</span><span class="mclose">)</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="col-align-l"><span class="vlist"><span style="top:-2.41em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mrel">=</span><span class="mopen">{</span><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="mclose">}</span></span></span><span style="top:-0.010000000000000397em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mrel">=</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="mopen">(</span><span class="mord mathit">c</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">e</span><span class="mord mathit">e</span><span class="mclose">)</span><span class="mord mspace"> </span><span class="mbin">∪</span><span class="mord mspace"> </span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="mopen">(</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="mclose">)</span></span></span><span style="top:2.39em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mrel">=</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mclose">)</span><span class="mord mspace"> </span><span class="mbin">∪</span><span class="mord mspace"> </span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="mopen">(</span><span class="mord mathit">e</span><span class="mord mathit">x</span><span class="mord mathit">p</span><span class="mclose">)</span><span class="mord mspace"> </span><span class="mbin">−</span><span class="mord mspace"> </span><span class="mopen">{</span><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="mclose">}</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></span></span>
<p>最后，作为一个整体的函数定义，其参数要从自由变量中剔除。这个可以留到之后的转换过程中实现。</p>
<p>在 rust 中同样可以直截了当的实现</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">fn</span> <span class="title">fv</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, source: &amp;Term) -&gt; HashSet&lt;Id&gt; &#123;</div><div class="line">    <span class="keyword">use</span> self::Term::*;</div><div class="line">    <span class="keyword">match</span> source &#123;</div><div class="line">        &amp;App(<span class="keyword">box</span> <span class="keyword">ref</span> callee, <span class="keyword">box</span> <span class="keyword">ref</span> body) =&gt; &#123;</div><div class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> ret = fv(body);</div><div class="line">            ret.extend(fv(callee));</div><div class="line">            ret</div><div class="line">        &#125;</div><div class="line">        &amp;Let(<span class="keyword">ref</span> var, <span class="keyword">box</span> <span class="keyword">ref</span> val, <span class="keyword">box</span> <span class="keyword">ref</span> body) =&gt; &#123;</div><div class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> ret = fv(body);</div><div class="line">            ret.remove(var);</div><div class="line">            ret.extend(fv(val));</div><div class="line">            ret</div><div class="line">        &#125;</div><div class="line">        &amp;Cls(<span class="keyword">ref</span> var, <span class="keyword">box</span> <span class="keyword">ref</span> cls, <span class="keyword">box</span> <span class="keyword">ref</span> body) =&gt; &#123;</div><div class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> ret = cls.fv();</div><div class="line">            ret.extend(fv(body));</div><div class="line">            ret.remove(var);</div><div class="line">        &#125;</div><div class="line">        &amp;Var(v) =&gt; HashSet::new(v)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">impl</span> Cls &#123;</div><div class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">fv</span></span>(&amp;<span class="keyword">self</span>) -&gt; HashSet&lt;Id&gt; &#123;</div><div class="line">        <span class="keyword">self</span>.fvs.clone()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="函数闭包转化"><a href="#函数闭包转化" class="headerlink" title="函数闭包转化"></a>函数闭包转化</h2><p>显然，为了实现 lambda 到全局定义的转换，我们需要保持一个全局定义表。为了之后方便的生成函数名和临时变量名之类可能还需要一个生成器，这里省略。</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Conversion</span></span> &#123;</div><div class="line">    global: HashMap&lt;Id, Fundef&gt;,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>综上所述，很容易写出转换过程。我们定义的 cls 节点有着类似与 let 的语义；当 lambda 单独出现时，这里直接将其转换成一个单独的定义了一个临时变量的 cls 子表达式（类似于嵌套 let）。</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><div class="line"><span class="keyword">impl</span> Conversion &#123;</div><div class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">define</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, fun: Fundef) &#123;</div><div class="line">        <span class="keyword">self</span>.global.insert(fun.label.clone(), fun);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">cvrt_cls</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, param: Id, body: Exp) -&gt; (Id, <span class="built_in">Vec</span>&lt;Id&gt;) &#123;</div><div class="line">        <span class="keyword">let</span> cls_name = <span class="keyword">self</span>.gen_cls_name();</div><div class="line">        <span class="keyword">let</span> body = <span class="keyword">self</span>.go(_body);</div><div class="line">        <span class="keyword">let</span> fvs = &#123;</div><div class="line">            <span class="keyword">let</span> _fvs = <span class="keyword">self</span>.fv(&amp;body);</div><div class="line">            _fvs.remove(param);</div><div class="line">            _fvs.into_iter().collect()</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">self</span>.define(Fundef &#123;</div><div class="line">            label: cls_name.clone(),</div><div class="line">            param,</div><div class="line">            body,</div><div class="line">            fvs.clone()</div><div class="line">        &#125;);</div><div class="line">        (cls_name, fvs)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">go</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, exp: Exp) -&gt; Term &#123;</div><div class="line">        <span class="keyword">use</span> self::Exp::*;</div><div class="line">        <span class="keyword">match</span> exp &#123;</div><div class="line">            Abs(param, <span class="keyword">box</span> _body) =&gt; &#123;</div><div class="line">                <span class="keyword">let</span> (cls_name, fvs) = <span class="keyword">self</span>.cvrt_cls(param, _body);</div><div class="line">                <span class="keyword">let</span> tmp_var = <span class="keyword">self</span>.gen_tmp_name();</div><div class="line">                Term::Cls(tmp_var, Cls &#123;</div><div class="line">                    label: cls_name,</div><div class="line">                    fvs</div><div class="line">                &#125;, Term::Var(tmp_var))</div><div class="line">            &#125;</div><div class="line">            Let(var, <span class="keyword">box</span> _val, <span class="keyword">box</span> _body) =&gt; &#123;</div><div class="line">                <span class="keyword">let</span> body = <span class="keyword">self</span>.go(_body);</div><div class="line">                <span class="keyword">if</span> <span class="keyword">let</span> Abs(param, <span class="keyword">box</span> _body) = _val &#123;</div><div class="line">                    <span class="keyword">let</span> (cls_name, fvs) = <span class="keyword">self</span>.cvrt_cls(param, _body);</div><div class="line">                    Term::Cls(var, Cls &#123;</div><div class="line">                        label: cls_name,</div><div class="line">                        fvs</div><div class="line">                    &#125;, body)</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">let</span> val = <span class="keyword">self</span>.go(_val);</div><div class="line">                    Term::Let(var, <span class="keyword">box</span> val, <span class="keyword">box</span> body)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            App(<span class="keyword">box</span> _callee, <span class="keyword">box</span> _arg) =&gt; &#123;</div><div class="line">                <span class="keyword">let</span> callee = <span class="keyword">self</span>.go(_callee);</div><div class="line">                <span class="keyword">let</span> arg = <span class="keyword">self</span>.go(_arg);</div><div class="line">                Term::App(callee, arg)</div><div class="line">            &#125;</div><div class="line">            Var(v) =&gt; Term::Var(v)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里对于 let 绑定 lambda 的处理是不把绑定的变量名剔除出自由变量。由于这里的 let 语义默认是不允许递归绑定的，而 lambda 很多时候有递归的需求，所以这里使用了灵活的办法：把lambda 自己的名称作为自由变量传进去。这样便可以通过后续代码生成的顺序控制能否递归：如果在完成函数名的绑定前先完成自由变量的绑定，便不允许递归，否则允许递归。</p>
<p>这样便完成了闭包转换的过程。后续便可以使用常规的编译技术生成所有的全局函数定义。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="http://link.zhihu.com/?target=https%3A//github.com/esumii/min-caml" target="_blank" rel="external">min-caml</a></p>
<p><a href="http://link.zhihu.com/?target=https%3A//jeapostrophe.github.io/courses/2017/spring/406/notes/book.pdf" target="_blank" rel="external">Essentials of Compilation</a></p>
<p><a href="http://link.zhihu.com/?target=http%3A//matt.might.net/articles/closure-conversion/" target="_blank" rel="external">Closure conversion: How to compile lambda</a></p>


      

    </section>
    
      <section class='ArticleMeta'>
          <div>
            发布于&nbsp;
            <time datetime="2017-09-04T08:16:53.000Z" itemprop="datePublished">
              2017-09-04
            </time>
          </div>
          
            <div>
              tags: 
  <li class="meta-text">
  { <a href="/tags/functional-programming/">functional programming</a> }
  </li>

  <li class="meta-text">
  { <a href="/tags/compile/">compile</a> }
  </li>


            </div>
          
      </section>
    
    
      <section>
        <div id="disqus_thread"></div>
        <script>
          window.disqus_config = function () {
            this.page.url = window.location.toString()
            this.page.identifier = window.location.pathname
          }
          if (typeof DISQUS === 'undefined') {
            (function() { // DON'T EDIT BELOW THIS LINE
              var d = document, s = d.createElement('script');
              s.src = 'https://hcyue.disqus.com/embed.js';
              s.setAttribute('data-timestamp', +new Date());
              (d.head || d.body).appendChild(s);
            })();
          } else {
            DISQUS.reset({
                reload: true,
                config: window.disqus_config
            })
          }
        </script>
      </section>
    
</article>

  
</div>

            <footer>
    <div>© 2016 - Hcyue  , CC BY-NC-SA 4.0 </div>
    <div>
    Powered by Hexo
    </div>
</footer>

        </div>
    </div>
</div>
<script src="/js/pager/dist/singlepager.js"></script>
<script>
var sp = new Pager('data-pager-shell')

</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>